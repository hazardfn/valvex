<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/travis/build/hazardfn/valvex/_build/test/cover/eunit/valvex_socket_event_handler.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/travis/build/hazardfn/valvex/_build/test/lib/valvex/ebin/../src/valvex_socket_event_handler.erl by COVER 2016-06-26 at 23:19:24

****************************************************************************

        |  -module(valvex_socket_event_handler).
        |  -behaviour(gen_event).
        |  
        |  %% gen_event exports
        |  -export([ init/1
        |          , handle_event/2
        |          , handle_call/2
        |          , handle_info/2
        |          , code_change/3
        |          , terminate/2
        |          ]).
        |  
        |  %% API exports
        |  -export([]).
        |  
        |  %%==============================================================================
        |  %% Gen Event API
        |  %%==============================================================================
        |  init([ {port, Port}
        |       , {handler, Handler}
        |       , {use_local, true}
        |       ]) -&gt;
    22..|    start_cowboy(Port, Handler),
    22..|    {ok, [{IP, _, _}, _]} = inet:getif(),
    22..|    Host = inet_parse:ntoa(IP),
    22..|    {ok, Gun}      = gun:open(Host, Port),
    22..|    {ok, Protocol} = gun:await_up(Gun),
    22..|    gun:ws_upgrade(Gun, "/websocket"),
    22..|    receive
        |      {gun_ws_upgrade, Gun, ok, _Headers} -&gt;
    22..|        ok;
        |      {gun_response, Gun, _, _, Status, Headers} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Status, Headers});</font>
        |      {gun_error, Gun, _StreamRef, Reason} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Reason})</font>
        |        %% More clauses here as needed.
        |    after 15000 -&gt;
<font color=red>     0..|        exit(timeout)</font>
        |    end,
    22..|    {ok, #{ gun      =&gt; Gun
        |          , host     =&gt; Host
        |          , port     =&gt; Port
        |          , protocol =&gt; Protocol
        |          }};
        |  init([ {host, Host}
        |       , {port, Port}
        |       ]) -&gt;
<font color=red>     0..|    {ok, Gun}      = gun:open(Host, Port),</font>
<font color=red>     0..|    {ok, Protocol} = gun:await_up(Gun),</font>
<font color=red>     0..|    gun:ws_upgrade(Gun, "/websocket"),</font>
<font color=red>     0..|    receive</font>
        |      {gun_ws_upgrade, Gun, ok, _Headers} -&gt;
<font color=red>     0..|        ok;</font>
        |      {gun_response, Gun, _, _, Status, Headers} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Status, Headers});</font>
        |      {gun_error, Gun, _StreamRef, Reason} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Reason})</font>
        |        %% More clauses here as needed.
        |    after 15000 -&gt;
<font color=red>     0..|        exit(timeout)</font>
        |    end,
<font color=red>     0..|    {ok, #{ gun      =&gt; Gun</font>
        |          , host     =&gt; Host
        |          , port     =&gt; Port
        |          , protocol =&gt; Protocol
        |          }}.
        |  
        |  handle_event({_, {Key, _, _, _, _, _}}, #{ gun := Gun } = S) -&gt;
   512..|    do_fudge(sys:get_state(Key), Gun),
   512..|    {ok, S};
        |  handle_event({_, {Key, _, _, _, _, _}, _}, #{ gun := Gun } = S) -&gt;
     6..|    do_fudge(sys:get_state(Key), Gun),
     6..|    {ok, S};
        |  handle_event({_, Key}, #{ gun := Gun } = S) -&gt;
    48..|    do_fudge(sys:get_state(Key), Gun),
    48..|    {ok, S};
        |  handle_event({_, Key, _, _}, #{ gun := Gun } = S) -&gt;
     4..|    do_fudge(sys:get_state(Key), Gun),
     4..|    {ok, S};
        |  handle_event({_, Key, _}, #{ gun := Gun } = S) -&gt;
    34..|    do_fudge(sys:get_state(Key), Gun),
    34..|    {ok, S}.
        |  
        |  do_fudge(QS, Gun) -&gt;
   604..|    QueueState = maps:put(created_at, format_utc_timestamp(), maps:put(name, dump, maps:remove(queue, maps:remove(q, maps:remove(consumer, maps:remove(queue_pid, QS)))))),
   604..|    gun:ws_send(Gun, jsonify(QueueState)).
        |  
        |  handle_info(_, State) -&gt;
   604..|    {ok, State}.
        |  
        |  handle_call(_, S) -&gt;
<font color=red>     0..|    {ok, ok, S}.</font>
        |  
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  terminate(_Reason, #{ gun := Gun }) -&gt;
    22..|    gun:shutdown(Gun).
        |  
        |  jsonify(Event) -&gt;
   604..|    {binary, jsx:encode(Event)}.
        |  
        |  start_cowboy(Port, Handler) -&gt;
    22..|    Dispatch = cowboy_router:compile([
        |                                      {'_', [
        |                                             {"/websocket", Handler, []}
        |                                            ]}
        |                                     ]),
    22..|    cowboy:start_clear(http, 100, [{port, Port}], #{ env =&gt; #{dispatch =&gt; Dispatch} }).
        |  
        |  format_utc_timestamp() -&gt;
   604..|    TS = {_,_,Micro} = os:timestamp(),
   604..|    {{Year,Month,Day},{Hour,Minute,Second}} = calendar:now_to_universal_time(TS),
   604..|    Mstr = element(Month,{"Jan","Feb","Mar","Apr","May","Jun","Jul",
        |                          "Aug","Sep","Oct","Nov","Dec"}),
   604..|    R = io_lib:format("~2w ~s ~4w ~2w:~2..0w:~2..0w.~6..~w", [Day,Mstr,Year,Hour,Minute,Second, Micro]),
   604..|    lists:flatten(R).
        |  
        |  %%%_* Emacs ====================================================================
        |  %%% Local Variables:
        |  %%% allout-layout: t
        |  %%% erlang-indent-level: 2
        |  %%% End:
</pre>
</body>
</html>
