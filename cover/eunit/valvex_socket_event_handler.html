<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/travis/build/hazardfn/valvex/_build/test/cover/eunit/valvex_socket_event_handler.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/travis/build/hazardfn/valvex/_build/test/lib/valvex/ebin/../src/valvex_socket_event_handler.erl by COVER 2016-06-26 at 23:55:19

****************************************************************************

        |  -module(valvex_socket_event_handler).
        |  -behaviour(gen_event).
        |  
        |  %% gen_event exports
        |  -export([ init/1
        |          , handle_event/2
        |          , handle_call/2
        |          , handle_info/2
        |          , code_change/3
        |          , terminate/2
        |          ]).
        |  
        |  %% API exports
        |  -export([]).
        |  
        |  %%==============================================================================
        |  %% Gen Event API
        |  %%==============================================================================
        |  init([ {port, Port}
        |       , {handler, Handler}
        |       , {use_local, true}
        |       ]) -&gt;
    22..|    start_cowboy(Port, Handler),
    22..|    {ok, [{IP, _, _}, _]} = inet:getif(),
    22..|    Host = inet_parse:ntoa(IP),
    22..|    {ok, Gun}      = gun:open(Host, Port),
    22..|    {ok, Protocol} = gun:await_up(Gun),
    22..|    gun:ws_upgrade(Gun, "/websocket"),
    22..|    receive
        |      {gun_ws_upgrade, Gun, ok, _Headers} -&gt;
    22..|        ok;
        |      {gun_response, Gun, _, _, Status, Headers} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Status, Headers});</font>
        |      {gun_error, Gun, _StreamRef, Reason} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Reason})</font>
        |        %% More clauses here as needed.
        |    after 15000 -&gt;
<font color=red>     0..|        exit(timeout)</font>
        |    end,
    22..|    {ok, #{ gun      =&gt; Gun
        |          , host     =&gt; Host
        |          , port     =&gt; Port
        |          , protocol =&gt; Protocol
        |          }};
        |  init([ {host, Host}
        |       , {port, Port}
        |       ]) -&gt;
<font color=red>     0..|    {ok, Gun}      = gun:open(Host, Port),</font>
<font color=red>     0..|    {ok, Protocol} = gun:await_up(Gun),</font>
<font color=red>     0..|    gun:ws_upgrade(Gun, "/websocket"),</font>
<font color=red>     0..|    receive</font>
        |      {gun_ws_upgrade, Gun, ok, _Headers} -&gt;
<font color=red>     0..|        ok;</font>
        |      {gun_response, Gun, _, _, Status, Headers} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Status, Headers});</font>
        |      {gun_error, Gun, _StreamRef, Reason} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Reason})</font>
        |        %% More clauses here as needed.
        |    after 15000 -&gt;
<font color=red>     0..|        exit(timeout)</font>
        |    end,
<font color=red>     0..|    {ok, #{ gun      =&gt; Gun</font>
        |          , host     =&gt; Host
        |          , port     =&gt; Port
        |          , protocol =&gt; Protocol
        |          }}.
        |  
        |  handle_event( {queue_started, {Key, {threshold, Threshold}, {timeout, Timeout, seconds}, {pushback, Pushback, seconds}, {poll_rate, Poll, ms}, Backend}}
        |              , #{ gun := Gun } = S) -&gt;
    78..|    Map = #{ key        =&gt; Key
        |           , threshold  =&gt; Threshold
        |           , timeout    =&gt; Timeout
        |           , pushback   =&gt; Pushback
        |           , poll_rate  =&gt; Poll
        |           , backend    =&gt; Backend
        |           , name       =&gt; queue_started
        |           , created_at =&gt; format_utc_timestamp()
        |           },
    78..|    gun:ws_send(Gun, jsonify(Map)),
    78..|    {ok, S};
        |  handle_event( {queue_consumer_started, {Key, {threshold, Threshold}, {timeout, Timeout, seconds}, {pushback, Pushback, seconds}, {poll_rate, Poll, ms}, Backend}}
        |              , #{ gun := Gun } = S) -&gt;
    82..|    Map = #{ key        =&gt; Key
        |           , threshold  =&gt; Threshold
        |           , timeout    =&gt; Timeout
        |           , pushback   =&gt; Pushback
        |           , poll_rate  =&gt; Poll
        |           , backend    =&gt; Backend
        |           , name       =&gt; queue_started
        |           , created_at =&gt; format_utc_timestamp()
        |           },
    82..|    gun:ws_send(Gun, jsonify(Map)),
    82..|    {ok, S};
        |  handle_event( {queue_consumer_stopped, {Key, {threshold, Threshold}, {timeout, Timeout, seconds}, {pushback, Pushback, seconds}, {poll_rate, Poll, ms}, Backend}}
        |              , #{ gun := Gun } = S) -&gt;
    10..|    Map = #{ key        =&gt; Key
        |           , threshold  =&gt; Threshold
        |           , timeout    =&gt; Timeout
        |           , pushback   =&gt; Pushback
        |           , poll_rate  =&gt; Poll
        |           , backend    =&gt; Backend
        |           , name       =&gt; queue_started
        |           , created_at =&gt; format_utc_timestamp()
        |           },
    10..|    gun:ws_send(Gun, jsonify(Map)),
    10..|    {ok, S};
        |  handle_event(Event, #{ gun := Gun } = S) -&gt;
   328..|    do_fudge(Gun, Event),
   318..|    {ok, S}.
        |  
        |  do_fudge(Gun, _Event) -&gt;
   328..|    ValvexState = sys:get_state(valvex),
   320..|    Queues      = maps:get(queues, ValvexState),
   320..|    QueueFun    = fun({Key, _, _, _, _, _}) -&gt;
   952..|                    [maps:remove(queue, maps:remove(q, maps:remove(consumer, maps:remove(queue_pid, sys:get_state(Key)))))]
        |                  end,
   320..|    QueueMapped = #{ mapped_queues =&gt; lists:flatmap(QueueFun, Queues) },
   318..|    QueueState  = maps:put(created_at, format_utc_timestamp(), maps:put(name, dump, QueueMapped)),
   318..|    gun:ws_send(Gun, jsonify(QueueState)).
        |  
        |  handle_info(_, State) -&gt;
   420..|    {ok, State}.
        |  
        |  handle_call(_, S) -&gt;
<font color=red>     0..|    {ok, ok, S}.</font>
        |  
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  terminate(_Reason, #{ gun := Gun }) -&gt;
    22..|    gun:shutdown(Gun).
        |  
        |  jsonify(Event) -&gt;
   488..|    {binary, jsx:encode(Event)}.
        |  
        |  start_cowboy(Port, Handler) -&gt;
    22..|    Dispatch = cowboy_router:compile([
        |                                      {'_', [
        |                                             {"/websocket", Handler, []}
        |                                            ]}
        |                                     ]),
    22..|    cowboy:start_clear(http, 100, [{port, Port}], #{ env =&gt; #{dispatch =&gt; Dispatch} }).
        |  
        |  format_utc_timestamp() -&gt;
   488..|    TS =  os:timestamp(),
   488..|    calendar:now_to_universal_time(TS).
        |  %%%_* Emacs ====================================================================
        |  %%% Local Variables:
        |  %%% allout-layout: t
        |  %%% erlang-indent-level: 2
        |  %%% End:
</pre>
</body>
</html>
