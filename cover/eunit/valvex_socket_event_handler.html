<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/travis/build/hazardfn/valvex/_build/test/cover/eunit/valvex_socket_event_handler.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/travis/build/hazardfn/valvex/_build/test/lib/valvex/ebin/../src/valvex_socket_event_handler.erl by COVER 2016-08-13 at 11:57:58

****************************************************************************

        |  -module(valvex_socket_event_handler).
        |  -behaviour(gen_event).
        |  
        |  %% gen_event exports
        |  -export([ init/1
        |          , handle_event/2
        |          , handle_call/2
        |          , handle_info/2
        |          , code_change/3
        |          , terminate/2
        |          ]).
        |  
        |  %% API exports
        |  -export([]).
        |  
        |  %%==============================================================================
        |  %% Gen Event API
        |  %%==============================================================================
        |  init([ {port, Port}
        |       , {handler, Handler}
        |       , {use_local, true}
        |       ]) -&gt;
<font color=red>     0..|    start_cowboy(Port, Handler),</font>
<font color=red>     0..|    {ok, [{IP, _, _}, _]} = inet:getif(),</font>
<font color=red>     0..|    Host = inet_parse:ntoa(IP),</font>
<font color=red>     0..|    {ok, Gun}      = gun:open(Host, Port),</font>
<font color=red>     0..|    {ok, Protocol} = gun:await_up(Gun),</font>
<font color=red>     0..|    gun:ws_upgrade(Gun, "/websocket"),</font>
<font color=red>     0..|    receive</font>
        |      {gun_ws_upgrade, Gun, ok, _Headers} -&gt;
<font color=red>     0..|        ok;</font>
        |      {gun_response, Gun, _, _, Status, Headers} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Status, Headers});</font>
        |      {gun_error, Gun, _StreamRef, Reason} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Reason})</font>
        |        %% More clauses here as needed.
        |    after 15000 -&gt;
<font color=red>     0..|        exit(timeout)</font>
        |    end,
<font color=red>     0..|    {ok, #{ gun      =&gt; Gun</font>
        |          , host     =&gt; Host
        |          , port     =&gt; Port
        |          , protocol =&gt; Protocol
        |          }};
        |  init([ {host, Host}
        |       , {port, Port}
        |       ]) -&gt;
<font color=red>     0..|    {ok, Gun}      = gun:open(Host, Port),</font>
<font color=red>     0..|    {ok, Protocol} = gun:await_up(Gun),</font>
<font color=red>     0..|    gun:ws_upgrade(Gun, "/websocket"),</font>
<font color=red>     0..|    receive</font>
        |      {gun_ws_upgrade, Gun, ok, _Headers} -&gt;
<font color=red>     0..|        ok;</font>
        |      {gun_response, Gun, _, _, Status, Headers} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Status, Headers});</font>
        |      {gun_error, Gun, _StreamRef, Reason} -&gt;
<font color=red>     0..|        exit({ws_upgrade_failed, Reason})</font>
        |        %% More clauses here as needed.
        |    after 15000 -&gt;
<font color=red>     0..|        exit(timeout)</font>
        |    end,
<font color=red>     0..|    {ok, #{ gun      =&gt; Gun</font>
        |          , host     =&gt; Host
        |          , port     =&gt; Port
        |          , protocol =&gt; Protocol
        |          }}.
        |  
        |  handle_event(Event, #{ gun := Gun } = S) -&gt;
<font color=red>     0..|    do_dump(Gun, Event),</font>
<font color=red>     0..|    {ok, S}.</font>
        |  
        |  do_dump(Gun, _Event) -&gt;
<font color=red>     0..|    Queues      = gen_server:call(valvex, get_queues, 2000),</font>
<font color=red>     0..|    QueueFun    = fun({Key, _, _, _, _, _, Backend}) -&gt;</font>
<font color=red>     0..|                      Pred = fun(K, _V) -&gt;</font>
<font color=red>     0..|                                 lists:member(K, map_blacklist()) == false</font>
        |                             end,
<font color=red>     0..|                      [maps:filter(Pred, valvex_queue:get_state(Backend, Key))]</font>
        |                  end,
<font color=red>     0..|    QueueMapped = #{ mapped_queues =&gt; lists:flatmap(QueueFun, Queues) },</font>
<font color=red>     0..|    BaseMap     = #{ created_at    =&gt; format_utc_timestamp()</font>
        |                   , name          =&gt; dump
        |                   },
<font color=red>     0..|    QueueState = maps:merge(BaseMap, QueueMapped),</font>
<font color=red>     0..|    gun:ws_send(Gun, jsonify(QueueState)).</font>
        |  
        |  map_blacklist() -&gt;
<font color=red>     0..|    [ queue, q, consumer, queue_pid ].</font>
        |  
        |  handle_info({'EXIT', _Pid, _Reason}, S) -&gt;
<font color=red>     0..|    gen_event:stop(self()),</font>
<font color=red>     0..|    {ok, S};</font>
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  handle_call(_, S) -&gt;
<font color=red>     0..|    {ok, ok, S}.</font>
        |  
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  terminate(_Reason, #{ gun := Gun }) -&gt;
<font color=red>     0..|    gun:shutdown(Gun),</font>
<font color=red>     0..|    ok.</font>
        |  
        |  jsonify(Event) -&gt;
<font color=red>     0..|    {binary, jsx:encode(Event)}.</font>
        |  
        |  start_cowboy(Port, Handler) -&gt;
<font color=red>     0..|    Dispatch = cowboy_router:compile([</font>
        |                                      {'_', [
        |                                             {"/websocket", Handler, []}
        |                                            ]}
        |                                     ]),
<font color=red>     0..|    cowboy:start_clear(http, 100, [{port, Port}], #{ env =&gt; #{dispatch =&gt; Dispatch} }).</font>
        |  
        |  format_utc_timestamp() -&gt;
<font color=red>     0..|    TS =  os:timestamp(),</font>
<font color=red>     0..|    calendar:now_to_universal_time(TS).</font>
        |  %%%_* Emacs ====================================================================
        |  %%% Local Variables:
        |  %%% allout-layout: t
        |  %%% erlang-indent-level: 2
        |  %%% End:
</pre>
</body>
</html>
