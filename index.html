<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Valvex by hazardfn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Valvex</h1>
      <h2 class="project-tagline">A rate-limiter in erlang with pushback.</h2>
      <a href="https://github.com/hazardfn/valvex" class="btn">View on GitHub</a>
      <a href="https://github.com/hazardfn/valvex/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/hazardfn/valvex/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="overview--" class="anchor" href="#overview--" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview | <a href="https://travis-ci.org/hazardfn/valvex"><img src="https://travis-ci.org/hazardfn/valvex.svg" alt="Travis-CI"></a>
</h1>

<hr>

<p>valveX is a rate-limiter written in erlang - it has a lot of tweakable
options to ensure you get the best solution.</p>

<h2>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>Support for unlimited queues (within the erlang process limit)</li>
<li>Each queue has independent state, allowing separate rules for each queue</li>
<li>Choose from different queue types, FIFO and LIFO are supported out the box using erlangs queue - create your own if these don't appeal to you.</li>
<li>Extensibility through the use of backends - each queue can use a different backend</li>
<li>Queues are supervised and restarted</li>
<li>Configurable threshold allowing for pushback under high load</li>
</ul>

<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>

<p>Before you can use valvex you need to configure environment variables in your sys.config or you can use the API to change the settings/add queues at runtime.
For more technical information view the technical docs <a href="http://hazardfn.github.io/valvex/doc">here</a>.</p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<p>Simply start valvex through the supervisor, it will then be registered
as <code>valvex</code> to be used throughout your application.</p>

<div class="highlight highlight-source-erlang"><pre><span class="pl-smi">Pid</span> <span class="pl-k">=</span> <span class="pl-en">valvex_sup</span>:<span class="pl-en">start_link</span>().</pre></div>

<p>Here is an example of how to create a queue at run time and push work to it then listen for the reply.</p>

<div class="highlight highlight-source-erlang"><pre><span class="pl-c">%% Add a queue with the key randomqueue that has a threshold of 1, a</span>
<span class="pl-c">%% timeout of 10 seconds, a pushback of 10 seconds, a poll rate of </span>
<span class="pl-c">%% 100ms and uses the valvex_queue_fifo_backend. there are various </span>
<span class="pl-c">%% options you can supply to add to change the behaviour, read the API </span>
<span class="pl-c">%% docs for more info.</span>
<span class="pl-c">%%</span>
<span class="pl-c">%% We shall use the message_event_handler which is not recommended as</span>
<span class="pl-c">%% order is not guaranteed and it can be hard to get the result of</span>
<span class="pl-c">%% your work - the below example should work but if not extend the</span>
<span class="pl-c">%% sleep.</span>


<span class="pl-smi">Pid</span> <span class="pl-k">=</span> <span class="pl-en">valvex_sup</span>:<span class="pl-en">start_link</span>(),
<span class="pl-en">valvex</span>:<span class="pl-en">add_handler</span>(<span class="pl-c1">valvex</span>, <span class="pl-c1">valvex_message_event_handler</span>, [<span class="pl-en">self</span>()]),

<span class="pl-smi">Key</span>       <span class="pl-k">=</span> <span class="pl-c1">randomqueue</span>,
<span class="pl-smi">Threshold</span> <span class="pl-k">=</span> {<span class="pl-c1">threshold</span>, <span class="pl-c1">1</span>},
<span class="pl-smi">Timeout</span>   <span class="pl-k">=</span> {<span class="pl-c1">timeout</span>, <span class="pl-c1">10</span>, <span class="pl-c1">seconds</span>},
<span class="pl-smi">Pushback</span>  <span class="pl-k">=</span> {<span class="pl-c1">pushback</span>, <span class="pl-c1">10</span>, <span class="pl-c1">seconds</span>},
<span class="pl-smi">Poll</span>      <span class="pl-k">=</span> {<span class="pl-c1">poll_rate</span>, <span class="pl-c1">100</span>, <span class="pl-c1">ms</span>},
<span class="pl-smi">Backend</span>   <span class="pl-k">=</span> <span class="pl-c1">valvex_queue_fifo_backend</span>,
<span class="pl-smi">Queue</span>     <span class="pl-k">=</span> {<span class="pl-smi">Key</span>, <span class="pl-smi">Threshold</span>, <span class="pl-smi">Timeout</span>, <span class="pl-smi">Pushback</span>, <span class="pl-smi">Poll</span>, <span class="pl-smi">Backend</span>},
<span class="pl-en">valvex</span>:<span class="pl-en">add</span>(<span class="pl-c1">valvex</span>, <span class="pl-smi">Queue</span>),
<span class="pl-smi">RandomFun</span> <span class="pl-k">=</span> <span class="pl-k">fun</span>() -&gt;
             <span class="pl-en">timer</span>:<span class="pl-en">sleep</span>(<span class="pl-c1">5000</span>),
             {<span class="pl-c1">expected_reply</span>, <span class="pl-c1">5000</span>}
            <span class="pl-k">end</span>,
<span class="pl-en">valvex</span>:<span class="pl-en">push</span>(<span class="pl-c1">valvex</span>, <span class="pl-smi">Key</span>, <span class="pl-smi">RandomFun</span>),
<span class="pl-en">flush</span>(),
<span class="pl-k">receive</span>
  {<span class="pl-c1">result</span>, {<span class="pl-c1">expected_reply</span>, <span class="pl-smi">Value</span>}} -&gt;
    <span class="pl-en">io</span>:<span class="pl-en">format</span>(<span class="pl-s"><span class="pl-pds">"</span>Value: <span class="pl-c1">~p~n</span><span class="pl-pds">"</span></span>, [<span class="pl-smi">Value</span>]);
  {<span class="pl-c1">timeout</span>, <span class="pl-smi">Key</span>} -&gt;
    <span class="pl-en">io</span>:<span class="pl-en">format</span>(<span class="pl-s"><span class="pl-pds">"</span>The timeout has been hit<span class="pl-pds">"</span></span>);
  {<span class="pl-c1">threshold_hit</span>, <span class="pl-smi">_Q</span>} -&gt;
    <span class="pl-en">io</span>:<span class="pl-en">format</span>(<span class="pl-s"><span class="pl-pds">"</span>The amount of work exceeded the threshold<span class="pl-pds">"</span></span>)
<span class="pl-k">after</span>
  <span class="pl-c1">15000</span> -&gt;
    <span class="pl-en">io</span>:<span class="pl-en">format</span>(<span class="pl-s"><span class="pl-pds">"</span>Some hard timeout was reached indicating something seriously went wrong<span class="pl-pds">"</span></span>)
<span class="pl-k">end</span>,
 <span class="pl-en">valvex</span>:<span class="pl-en">remove_handler</span>(<span class="pl-c1">valvex</span>, <span class="pl-c1">valvex_message_event_handler</span>, []).</pre></div>

<p>Output:</p>

<pre><code>Shell got {queue_started,{randomqueue,{threshold,1},
                                      {timeout,10,seconds},
                                      {pushback,10,seconds},
                                      {poll_rate,100,ms},
                                      valvex_queue_fifo_backend}}
Shell got {queue_consumer_started,
              {randomqueue,
                  {threshold,1},
                  {timeout,10,seconds},
                  {pushback,10,seconds},
                  {poll_rate,100,ms},
                  valvex_queue_fifo_backend}}
Shell got {queue_push,{randomqueue,{threshold,1},
                                   {timeout,10,seconds},
                                   {pushback,10,seconds},
                                   {poll_rate,100,ms},
                                   valvex_queue_fifo_backend},
                      #Fun&lt;erl_eval.20.54118792&gt;}
Shell got {push_complete,{randomqueue,{threshold,1},
                                      {timeout,10,seconds},
                                      {pushback,10,seconds},
                                      {poll_rate,100,ms},
                                      valvex_queue_fifo_backend},
                         #Fun&lt;erl_eval.20.54118792&gt;}
Value: 5000
ok
</code></pre>

<h2>
<a id="api" class="anchor" href="#api" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>API</h2>

<p>This sections attempts to document the API and it's behaviour under certain scenarios.</p>

<h3>
<a id="add-identifier-queue-key-threshold-timeout-pushback-poll-queue-backend-option---ok--error-key_not_unique" class="anchor" href="#add-identifier-queue-key-threshold-timeout-pushback-poll-queue-backend-option---ok--error-key_not_unique" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>add (Identifier, {Queue Key, Threshold, Timeout, Pushback, Poll, Queue Backend}, Option) -&gt; ok | {error, key_not_unique}.</code>
</h3>

<hr>

<h4>
<a id="description" class="anchor" href="#description" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Description:</h4>

<p>Adds a queue at runtime. An add/2 operation also exists removing the need for options.</p>

<h4>
<a id="spec" class="anchor" href="#spec" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Spec:</h4>

<p><strong>Identifier:</strong> Pid or registered atom of the valve server.</p>

<p><strong>Queue Key:</strong> A unique atom identifying the queue.</p>

<p><strong>Threshold:</strong> Count of work items allowed on the queue before it starts to push back.</p>

<p><strong>Timeout:</strong> A value that indicates when the work this queue will receive has gone on too long - this value is also used as part of the pushback.</p>

<p><strong>Pushback:</strong> In the event of the threshold being hit valvex will wait x seconds before responding to the client, this prevents users from receiving an instant response decreasing the chance that they will constantly spam refresh your page causing more work / requests.</p>

<p><strong>Poll:</strong> A value that indicates how often the queue should be polled.</p>

<p><strong>Option:</strong> An atom which can change how add works:</p>

<p><code>crossover_on_existing</code></p>

<p><code>crossover_on_existing_force_remove</code></p>

<p><strong>Queue Backend:</strong> A module that uses the queue behaviour you need, there are some defaults:</p>

<p><code>valvex_fifo_queue_backend</code></p>

<p><code>valvex_lifo_queue_backend</code></p>

<p>Feel free to create your own with any additional features you may need.</p>

<h4>
<a id="notes" class="anchor" href="#notes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Notes:</h4>

<p>The functionality of add differs depending on the option you supply, by default if you try to add a key that isn't unique you will receive an <code>{error, key_not_unique}</code> back.</p>

<p><code>crossover_on_existing</code> will create your new queue regardless of key uniqueness and all future requests will go to that queue, the old one will be tombstoned and locked - this means it will process any work it has left using old values (Timeout, Pushback etc.) then kill itself. This is good when you want to change queue settings but not disturb ongoing requests.</p>

<p><code>crossover_on_existing_force_remove</code> will add your new queue and immediately kill the old queue regardless of contents - this can be highly disruptive and is only useful in some corner cases.</p>

<h3>
<a id="remove-identifier-queue-key-option---ok--error-key_not_found" class="anchor" href="#remove-identifier-queue-key-option---ok--error-key_not_found" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>remove (Identifier, Queue Key, Option) -&gt; ok | {error, key_not_found}.</code>
</h3>

<hr>

<h4>
<a id="description-1" class="anchor" href="#description-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Description:</h4>

<p>Triggers a queue removal at runtime. A remove/2 operation also exists removing the need for options.</p>

<h4>
<a id="spec-1" class="anchor" href="#spec-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Spec:</h4>

<p><strong>Identifier:</strong> Pid or registered atom of the valve server.</p>

<p><strong>Queue Key:</strong> A unique atom identifying the queue.</p>

<p><strong>Option:</strong> An atom that can change how remove works:</p>

<p><code>force_remove</code></p>

<p><code>lock_queue</code></p>

<h4>
<a id="notes-1" class="anchor" href="#notes-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Notes:</h4>

<p>By default remove is a safe operation, it will merely mark a queue for removal and only remove it when it has no remaining work - it can still continue to receive work however, this is by design to prevent crashes. If a queue marked for removal is continuing to receive work it will print a warning. You can specify options to change this behaviour.</p>

<p><code>force_remove</code> will kill a queue regardless of it's contents, again please use this carefully.</p>

<p><code>lock_queue</code> will remove as normal but prevent the queue from receiving new work, while in most cases safe your code can crash if you have forgot to remove all instances where the queue being removed is used.</p>

<h3>
<a id="push-identifier-queue-key-work---ok" class="anchor" href="#push-identifier-queue-key-work---ok" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>push (Identifier, Queue Key, Work) -&gt; ok.</code>
</h3>

<hr>

<h4>
<a id="description-2" class="anchor" href="#description-2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Description:</h4>

<p>Pushes work to the queue with the queue key you specified. Will not error if the queue does not exist.</p>

<h4>
<a id="spec-2" class="anchor" href="#spec-2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Spec:</h4>

<p><strong>Identifier:</strong> Pid or registered atom of the valve server.</p>

<p><strong>Queue Key:</strong> A unique atom identifying the queue.</p>

<p><strong>Work:</strong> A fun() of stuff to do.</p>

<h3>
<a id="get_available_workers-identifier---pid" class="anchor" href="#get_available_workers-identifier---pid" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>get_available_workers (Identifier) -&gt; [pid()].</code>
</h3>

<hr>

<h4>
<a id="description-3" class="anchor" href="#description-3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Description:</h4>

<p>Gets a list of pid's that represent your available workers.</p>

<h4>
<a id="spec-3" class="anchor" href="#spec-3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Spec:</h4>

<p><strong>Identifier:</strong> Pid or registered atom of the valve server.</p>

<h3>
<a id="get_available_workers_count-identifier---non_neg_integer" class="anchor" href="#get_available_workers_count-identifier---non_neg_integer" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>get_available_workers_count (Identifier) -&gt; non_neg_integer()</code>
</h3>

<hr>

<h4>
<a id="description-4" class="anchor" href="#description-4" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Description:</h4>

<p>Gets the number of workers currently available (not processing work).</p>

<h4>
<a id="spec-4" class="anchor" href="#spec-4" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Spec:</h4>

<p><strong>Identifier:</strong> Pid or registered atom of the valve server.</p>

<h3>
<a id="get_queue_size-identifier-queue-key---non_neg_integer--error-key_not_found" class="anchor" href="#get_queue_size-identifier-queue-key---non_neg_integer--error-key_not_found" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>get_queue_size (Identifier, Queue Key) -&gt; non_neg_integer() | {error, key_not_found}.</code>
</h3>

<hr>

<h4>
<a id="description-5" class="anchor" href="#description-5" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Description:</h4>

<p>Gets the current number of items in a specified queue.</p>

<h4>
<a id="spec-5" class="anchor" href="#spec-5" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Spec:</h4>

<p><strong>Identifier:</strong> Pid or registered atom of the valve server.</p>

<p><strong>Queue Key:</strong> A unique atom identifying the queue.</p>

<h3>
<a id="pushback-identifier-queue-key---ok" class="anchor" href="#pushback-identifier-queue-key---ok" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>pushback (Identifier, Queue Key) -&gt; ok.</code>
</h3>

<hr>

<h4>
<a id="description-6" class="anchor" href="#description-6" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Description:</h4>

<p>Simply waits for the pushback limit of the specified queue and
responds {threshold_hit, _Q} via eventing.</p>

<h4>
<a id="spec-6" class="anchor" href="#spec-6" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Spec:</h4>

<p><strong>Identifier:</strong> Pid or registered atom of the valve server.</p>

<p><strong>Queue Key:</strong> A unique atom identifying the queue.</p>

<h3>
<a id="notify-identifier-event---ok" class="anchor" href="#notify-identifier-event---ok" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>notify (Identifier, Event) -&gt; ok.</code>
</h3>

<hr>

<h4>
<a id="description-7" class="anchor" href="#description-7" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Description:</h4>

<p>Notifies any added handlers of an event.</p>

<h4>
<a id="spec-7" class="anchor" href="#spec-7" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Spec:</h4>

<p><strong>Identifier:</strong> Pid or registered atom of the valve server.</p>

<p><strong>Queue Key:</strong> An event (see list of valid events in notes)</p>

<h4>
<a id="notes-2" class="anchor" href="#notes-2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Notes:</h4>

<p>Valid events:</p>

<ul>
<li>{queue_crossover, Q, NuQ} - Triggered when a crossover occurs, Q is
the old queue and NuQ is the new queue.</li>
<li>{queue_started, Q} - Triggered on start_link</li>
<li>{queue_popped, Q} - Triggered when pop is called</li>
<li>{queue_popped_r, Q} - Triggered when pop_r is called</li>
<li>{queue_push, Q, Work} - Triggered when push is called, regardless of outcome</li>
<li>{queue_push_r, Q, Work} - See push.</li>
<li>{push_complete, Q, Work} - Triggered when the push operation was a success</li>
<li>{push_to_locked_queue, Q, Work} - Triggered when there's an attempt
to push to a locked queue</li>
<li>{queue_removed, Key} - Triggered when a tombstoned queue is finally removed</li>
<li>{queue_tombstoned, Q} - Triggered when a queue is marked to die</li>
<li>{queue_locked, Q} - Triggered when a queue is locked</li>
<li>{queue_unlocked, Q} - Triggered when a queue is unlocked</li>
<li>{queue_consumer_started, Q} - Triggered when the consumer is started</li>
<li>{queue_consumer_stopped, Q} - Triggered when the consumer is stopped</li>
<li>{timeout, QKey} - Triggered when the work goes stale</li>
<li>{result, Result} - Triggered when work is finally over</li>
<li>{threshold_hit, Q} - Triggered when a push is attempted but there's
already too many items.</li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/hazardfn/valvex">Valvex</a> is maintained by <a href="https://github.com/hazardfn">hazardfn</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
